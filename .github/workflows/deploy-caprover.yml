name: Deploy to CapRover (Manual Tarball)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend to CapRover
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if secrets are configured
        run: |
          if [ -z "${{ secrets.CAPROVER_URL }}" ]; then
            echo "::warning::CAPROVER_URL secret is not set. Skipping deployment."
            echo "::notice::Configure GitHub Secrets to enable automatic deployment."
            exit 0
          fi

      - name: Set up Node.js
        if: secrets.CAPROVER_URL != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CapRover CLI
        if: secrets.CAPROVER_URL != ''
        run: npm install -g caprover

      - name: Create backend deployment tarball
        if: secrets.CAPROVER_URL != ''
        run: |
          echo "Creating backend tarball..."
          cp captain-definition-backend captain-definition
          tar -czf backend-deploy.tar.gz \
            --exclude='multivendor_platform/front_end' \
            --exclude='**/venv' \
            --exclude='**/__pycache__' \
            --exclude='**/.pytest_cache' \
            --exclude='**/node_modules' \
            --exclude='*.pyc' \
            --exclude='*.pyo' \
            --exclude='*.sqlite3' \
            --exclude='.git' \
            captain-definition \
            Dockerfile.backend \
            multivendor_platform/
          
          echo "Tarball contents:"
          tar -tzf backend-deploy.tar.gz | head -20
          echo "Tarball size: $(du -h backend-deploy.tar.gz | cut -f1)"

      - name: Deploy Backend to CapRover
        if: secrets.CAPROVER_URL != ''
        env:
          CAPROVER_URL: ${{ secrets.CAPROVER_URL }}
          CAPROVER_PASSWORD: ${{ secrets.CAPROVER_PASSWORD }}
          CAPROVER_APP_NAME: ${{ secrets.CAPROVER_BACKEND_APP_NAME }}
        run: |
          if [ -z "$CAPROVER_URL" ] || [ -z "$CAPROVER_PASSWORD" ] || [ -z "$CAPROVER_APP_NAME" ]; then
            echo "::error::Missing required secrets for deployment"
            exit 1
          fi
          
          echo "Deploying backend to CapRover..."
          caprover deploy \
            --caproverUrl "$CAPROVER_URL" \
            --caproverPassword "$CAPROVER_PASSWORD" \
            --appName "$CAPROVER_APP_NAME" \
            --tarFile backend-deploy.tar.gz
          
          echo "‚úÖ Backend deployed successfully to CapRover!"
          echo "üîó Backend URL: https://multivendor-backend.indexo.ir"
          echo "üìù Note: Migrations and static files are collected automatically via Dockerfile CMD"

  deploy-frontend:
    name: Deploy Frontend to CapRover
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if secrets are configured
        run: |
          if [ -z "${{ secrets.CAPROVER_URL }}" ]; then
            echo "::warning::CAPROVER_URL secret is not set. Skipping deployment."
            exit 0
          fi

      - name: Set up Node.js
        if: secrets.CAPROVER_URL != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CapRover CLI
        if: secrets.CAPROVER_URL != ''
        run: npm install -g caprover

      - name: Create frontend deployment tarball
        if: secrets.CAPROVER_URL != ''
        run: |
          echo "Creating frontend tarball..."
          cp captain-definition-frontend captain-definition
          tar -czf frontend-deploy.tar.gz \
            --exclude='**/node_modules' \
            --exclude='**/dist' \
            --exclude='**/.output' \
            --exclude='**/.nuxt' \
            --exclude='**/__pycache__' \
            --exclude='.git' \
            captain-definition \
            multivendor_platform/front_end/nuxt/
          
          echo "Tarball contents:"
          tar -tzf frontend-deploy.tar.gz | head -20
          echo "Tarball size: $(du -h frontend-deploy.tar.gz | cut -f1)"

      - name: Deploy Frontend to CapRover
        if: secrets.CAPROVER_URL != ''
        env:
          CAPROVER_URL: ${{ secrets.CAPROVER_URL }}
          CAPROVER_PASSWORD: ${{ secrets.CAPROVER_PASSWORD }}
          CAPROVER_APP_NAME: ${{ secrets.CAPROVER_FRONTEND_APP_NAME }}
        run: |
          if [ -z "$CAPROVER_URL" ] || [ -z "$CAPROVER_PASSWORD" ] || [ -z "$CAPROVER_APP_NAME" ]; then
            echo "::error::Missing required secrets for deployment"
            exit 1
          fi
          
          echo "Deploying frontend to CapRover..."
          caprover deploy \
            --caproverUrl "$CAPROVER_URL" \
            --caproverPassword "$CAPROVER_PASSWORD" \
            --appName "$CAPROVER_APP_NAME" \
            --tarFile frontend-deploy.tar.gz

      - name: Frontend deployment successful
        if: secrets.CAPROVER_URL != ''
        run: |
          echo "‚úÖ Frontend deployed successfully to CapRover!"
          echo "üîó Frontend URL: https://indexo.ir"

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          echo "=========================================="
          echo "üöÄ DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo "Backend Status: ${{ needs.deploy-backend.result }}"
          echo "Frontend Status: ${{ needs.deploy-frontend.result }}"
          echo "=========================================="
          echo "üìç URLs:"
          echo "  Frontend: https://indexo.ir"
          echo "  Backend: https://backend.indexo.ir/api"
          echo "  Admin: https://backend.indexo.ir/admin"
          echo "=========================================="

