name: Deploy to CapRover

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  CAPROVER_SERVER: https://captain.indexo.ir

permissions:
  contents: read
  deployments: write

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify backend captain-definition exists
        run: |
          if [ ! -f "./captain-definition" ]; then
            echo "‚ùå captain-definition file not found in root directory"
            exit 1
          fi
          echo "‚úÖ captain-definition found"
          
      - name: Verify backend Dockerfile exists
        run: |
          if [ ! -f "./Dockerfile" ]; then
            echo "‚ùå Dockerfile not found in root directory"
            exit 1
          fi
          echo "‚úÖ Dockerfile found"
          
      - name: Security scan - check for secrets in code
        run: |
          echo "üîç Scanning for potential secrets..."
          if grep -r "SECRET_KEY\|PASSWORD\|TOKEN\|API_KEY" --include="*.py" --include="*.env*" --include="*.json" --include="*.yml" --include="*.yaml" multivendor_platform/ | grep -v "os.environ.get\|process.env" | grep -v "settings\|example\|test\|static\|node_modules\|AUTH_TOKEN_COOKIE\|TOUR_STORAGE_KEY\|TOUR_DISMISSED_KEY\|TOUR_PROGRESS_KEY" | grep -E "=\\s*['\"][^'\"]+['\"]|:\\s*['\"][^'\"]+['\"]"; then
            echo "‚ö†Ô∏è  Potential hardcoded secrets found! Please review."
            exit 1
          else
            echo "‚úÖ No obvious hardcoded secrets found"
          fi
          
      - name: Install CapRover CLI
        run: |
          npm install -g caprover
          
      - name: Create deployment tar file
        run: |
          tar -czf deploy.tar.gz captain-definition Dockerfile requirements.txt multivendor_platform/
          ls -la
          
      - name: Deploy Backend to CapRover
        run: |
          caprover deploy -h ${{ env.CAPROVER_SERVER }} -p ${{ secrets.CAPROVER_PASSWORD }} -a ${{ secrets.CAPROVER_BACKEND_APP_NAME }} -t deploy.tar.gz

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify frontend captain-definition exists
        run: |
          if [ ! -f "./multivendor_platform/front_end/nuxt/captain-definition" ]; then
            echo "‚ùå Frontend captain-definition file not found"
            exit 1
          fi
          echo "‚úÖ Frontend captain-definition found"
          
      - name: Verify frontend Dockerfile exists
        run: |
          if [ ! -f "./multivendor_platform/front_end/nuxt/Dockerfile" ]; then
            echo "‚ùå Frontend Dockerfile not found"
            exit 1
          fi
          echo "‚úÖ Frontend Dockerfile found"
          
      - name: Install CapRover CLI
        run: |
          npm install -g caprover
          
      - name: Create deployment tar file for frontend
        run: |
          cd multivendor_platform/front_end/nuxt
          tar -czf deploy-frontend.tar.gz captain-definition Dockerfile ./
          ls -la
          cd ../../../
          
      - name: Deploy Frontend to CapRover
        run: |
          caprover deploy -h ${{ env.CAPROVER_SERVER }} -p ${{ secrets.CAPROVER_PASSWORD }} -a ${{ secrets.CAPROVER_FRONTEND_APP_NAME }} -t multivendor_platform/front_end/nuxt/deploy-frontend.tar.gz
