name: Deploy to CapRover

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install CapRover CLI
        run: npm install -g caprover
      
      - name: Create deployment tarball
        run: |
          tar -czf deploy.tar.gz captain-definition Dockerfile requirements.txt multivendor_platform/
      
      - name: Deploy to CapRover
        run: |
          caprover deploy \
            --caproverUrl ${{ secrets.CAPROVER_SERVER }} \
            --appToken ${{ secrets.CAPROVER_APP_TOKEN_BACKEND }} \
            --appName ${{ secrets.CAPROVER_APP_BACKEND }} \
            --tarFile deploy.tar.gz

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install CapRover CLI
        run: npm install -g caprover
      
      - name: Create deployment tarball
        working-directory: ./multivendor_platform/front_end/nuxt
        run: |
          tar -czf deploy.tar.gz captain-definition Dockerfile package*.json nuxt.config.ts tsconfig.json app.vue public/ components/ composables/ layouts/ middleware/ pages/ plugins/ server/ stores/ assets/ types/
      
      - name: Deploy to CapRover
        working-directory: ./multivendor_platform/front_end/nuxt
        run: |
          caprover deploy \
            --caproverUrl ${{ secrets.CAPROVER_SERVER }} \
            --appToken ${{ secrets.CAPROVER_APP_TOKEN_FRONTEND }} \
            --appName ${{ secrets.CAPROVER_APP_FRONTEND }} \
            --tarFile deploy.tar.gz
