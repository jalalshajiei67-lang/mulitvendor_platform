name: Deploy to CapRover

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Create deployment tarball
        run: |
          tar -czf deploy.tar captain-definition Dockerfile requirements.txt multivendor_platform/
      
      - name: Deploy to CapRover via API
        run: |
          curl -X POST \
            ${{ secrets.CAPROVER_SERVER }}/api/v2/user/apps/webhooks/triggerbuild \
            -H "Content-Type: application/json" \
            -H "x-captain-app-token: ${{ secrets.CAPROVER_APP_TOKEN_BACKEND }}" \
            -H "x-namespace: captain" \
            -F "sourceFile=@deploy.tar"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Create deployment tarball
        working-directory: ./multivendor_platform/front_end/nuxt
        run: |
          tar -czf deploy.tar captain-definition Dockerfile package*.json nuxt.config.ts tsconfig.json app.vue public/ components/ composables/ layouts/ middleware/ pages/ plugins/ server/ stores/ assets/ types/
      
      - name: Deploy to CapRover via API
        working-directory: ./multivendor_platform/front_end/nuxt
        run: |
          curl -X POST \
            ${{ secrets.CAPROVER_SERVER }}/api/v2/user/apps/webhooks/triggerbuild \
            -H "Content-Type: application/json" \
            -H "x-captain-app-token: ${{ secrets.CAPROVER_APP_TOKEN_FRONTEND }}" \
            -H "x-namespace: captain" \
            -F "sourceFile=@deploy.tar"
