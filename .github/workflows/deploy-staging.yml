name: Deploy Staging
on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy files to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "."
          target: "/root/indexo-staging"
          rm: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            # Navigate to project directory
            cd /root/indexo-staging
            
            # Generate SECRET_KEY if .env.staging doesn't exist or SECRET_KEY is invalid
            if [ ! -f .env.staging ] || ! grep -q "SECRET_KEY=django-insecure-" .env.staging; then
              SECRET_KEY=$(openssl rand -base64 48 | tr -d '\n')
              cat > .env.staging << EOF
            DB_NAME=multivendor_db_staging
            DB_USER=postgres
            DB_PASSWORD=MySecurePassword123!
            DB_HOST=db
            DB_PORT=5432
            REDIS_HOST=redis
            REDIS_PORT=6379
            SECRET_KEY=django-insecure-${SECRET_KEY}
            DEBUG=False
            ALLOWED_HOSTS=localhost,127.0.0.1,backend,staging.indexo.ir,api-staging.indexo.ir
            MAIN_DOMAIN=staging.indexo.ir
            API_DOMAIN=api-staging.indexo.ir
            CSRF_TRUSTED_ORIGINS=https://staging.indexo.ir,https://api-staging.indexo.ir
            CORS_ALLOWED_ORIGINS=https://staging.indexo.ir
            CORS_ALLOW_ALL_ORIGINS=False
            NODE_ENV=production
            NUXT_HOST=0.0.0.0
            NUXT_PORT=3000
            NUXT_PUBLIC_API_BASE=https://api-staging.indexo.ir/api
            EOF
            fi
            
            # Copy .env.staging to .env for Docker Compose variable substitution
            # Docker Compose automatically reads .env file for ${VARIABLE} substitution
            cp .env.staging .env
            
            # Stop and remove old containers using docker compose (more reliable)
            docker compose -f docker-compose.staging.yml down || true
            
            # Also manually stop containers with staging suffix (in case compose down fails)
            docker stop multivendor_backend_staging multivendor_frontend_staging multivendor_db_staging multivendor_redis_staging multivendor_nginx_staging traefik_staging 2>/dev/null || true
            docker rm multivendor_backend_staging multivendor_frontend_staging multivendor_db_staging multivendor_redis_staging multivendor_nginx_staging traefik_staging 2>/dev/null || true
            
            # Ensure network exists (will be created by docker compose if not exists)
            docker network create multivendor_network --driver bridge || true
            
            # Deploy new version (Docker Compose will use .env for variable substitution)
            docker compose -f docker-compose.staging.yml up -d --build
            
            # Clean up unused images
            docker image prune -f
