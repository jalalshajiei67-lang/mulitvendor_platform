name: Deploy to CapRover Staging

on:
  push:
    branches: [ staging ]
  workflow_dispatch:

jobs:
  deploy-backend-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CapRover CLI
        run: npm install -g caprover

      - name: Create backend deployment tarball
        run: |
          cp captain-definition-backend captain-definition
          tar -czf backend-deploy.tar.gz \
            --exclude='multivendor_platform/front_end' \
            --exclude='multivendor_platform/multivendor_platform/venv' \
            --exclude='multivendor_platform/multivendor_platform/__pycache__' \
            --exclude='multivendor_platform/multivendor_platform/*/__pycache__' \
            --exclude='multivendor_platform/multivendor_platform/*/migrations/__pycache__' \
            --exclude='*.pyc' \
            --exclude='*.pyo' \
            captain-definition \
            Dockerfile.backend \
            docker-entrypoint.sh \
            multivendor_platform/ \
            requirements.txt

      - name: Deploy Backend to CapRover (Staging)
        env:
          CAPROVER_URL: ${{ secrets.CAPROVER_URL }}
          CAPROVER_PASSWORD: ${{ secrets.CAPROVER_PASSWORD }}
          CAPROVER_APP_NAME: ${{ secrets.CAPROVER_BACKEND_STAGING_APP_NAME }}
        run: |
          caprover deploy \
            --caproverUrl "$CAPROVER_URL" \
            --caproverPassword "$CAPROVER_PASSWORD" \
            --appName "$CAPROVER_APP_NAME" \
            --tarFile backend-deploy.tar.gz
          
          echo "‚úÖ Backend deployed successfully to CapRover (Staging)!"
          echo "üîó Backend URL: https://staging-api.indexo.ir"

  deploy-frontend-staging:
    name: Deploy Frontend to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    needs: deploy-backend-staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CapRover CLI
        run: npm install -g caprover

      - name: Create frontend deployment tarball (Staging)
        run: |
          cp captain-definition-frontend-staging captain-definition
          tar -czf frontend-deploy.tar.gz \
            --exclude='multivendor_platform/front_end/nuxt/node_modules' \
            --exclude='multivendor_platform/front_end/nuxt/.nuxt' \
            --exclude='multivendor_platform/front_end/nuxt/.output' \
            --exclude='multivendor_platform/front_end/node_modules' \
            --exclude='multivendor_platform/front_end/dist' \
            captain-definition \
            Dockerfile.frontend.staging.nuxt \
            multivendor_platform/front_end/
          echo "‚úÖ Created deployment tarball with staging configuration"

      - name: Deploy Frontend to CapRover (Staging)
        env:
          CAPROVER_URL: ${{ secrets.CAPROVER_URL }}
          CAPROVER_PASSWORD: ${{ secrets.CAPROVER_PASSWORD }}
          CAPROVER_APP_NAME: ${{ secrets.CAPROVER_FRONTEND_STAGING_APP_NAME }}
        run: |
          caprover deploy \
            --caproverUrl "$CAPROVER_URL" \
            --caproverPassword "$CAPROVER_PASSWORD" \
            --appName "$CAPROVER_APP_NAME" \
            --tarFile frontend-deploy.tar.gz

      - name: Frontend deployment successful (Staging)
        run: |
          echo "‚úÖ Frontend deployed successfully to CapRover (Staging)!"
          echo "üîó Frontend URL: https://staging.indexo.ir"

  deployment-summary-staging:
    name: Deployment Summary (Staging)
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, deploy-frontend-staging]
    if: always()
    
    steps:
      - name: Deployment Status (Staging)
        run: |
          echo "=========================================="
          echo "üöÄ DEPLOYMENT SUMMARY (STAGING)"
          echo "=========================================="
          echo "Backend Status: ${{ needs.deploy-backend-staging.result }}"
          echo "Frontend Status: ${{ needs.deploy-frontend-staging.result }}"
          echo "=========================================="
          echo "üìç URLs (Staging):"
          echo "  Frontend: https://staging.indexo.ir"
          echo "  Backend: https://staging-api.indexo.ir/api"
          echo "  Admin: https://staging-api.indexo.ir/admin"
          echo "=========================================="



