name: Deploy Staging
on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy files to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "."
          target: "/root/indexo-staging"
          rm: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            # Navigate to project directory
            cd /root/indexo-staging
            
            # Ensure .env.staging file exists (should already be on VPS, not in git)
            if [ ! -f .env.staging ]; then
              echo "ERROR: .env.staging file not found!"
              exit 1
            fi
            
            # Copy .env.staging to .env for Docker Compose variable substitution
            # Docker Compose automatically reads .env file for ${VARIABLE} substitution
            cp .env.staging .env
            
            # Stop and remove old containers using docker compose (more reliable)
            docker compose -f docker-compose.staging.yml down || true
            
            # Also manually stop containers with staging suffix (in case compose down fails)
            docker stop multivendor_backend_staging multivendor_frontend_staging multivendor_db_staging multivendor_redis_staging multivendor_nginx_staging traefik_staging 2>/dev/null || true
            docker rm multivendor_backend_staging multivendor_frontend_staging multivendor_db_staging multivendor_redis_staging multivendor_nginx_staging traefik_staging 2>/dev/null || true
            
            # Ensure network exists
            docker network create multivendor_network --driver bridge || true
            
            # Deploy new version (Docker Compose will use .env for variable substitution)
            docker compose -f docker-compose.staging.yml up -d --build
            
            # Clean up unused images
            docker image prune -f
