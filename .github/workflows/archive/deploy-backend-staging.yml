name: Deploy Backend to Staging

on:
  push:
    branches: [ staging ]
  workflow_dispatch:

jobs:
  deploy-backend-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # No cache needed - we only install CapRover CLI

      - name: Install CapRover CLI
        run: npm install -g caprover

      - name: Create backend deployment tarball
        run: |
          cp captain-definition-backend captain-definition
          tar -czf backend-deploy.tar.gz \
            --exclude='multivendor_platform/front_end' \
            --exclude='multivendor_platform/multivendor_platform/venv' \
            --exclude='multivendor_platform/multivendor_platform/__pycache__' \
            --exclude='multivendor_platform/multivendor_platform/*/__pycache__' \
            --exclude='multivendor_platform/multivendor_platform/*/migrations/__pycache__' \
            --exclude='*.pyc' \
            --exclude='*.pyo' \
            captain-definition \
            Dockerfile.backend \
            docker-entrypoint.sh \
            multivendor_platform/ \
            requirements.txt

      - name: Deploy Backend to CapRover (Staging)
        env:
          CAPROVER_URL: ${{ secrets.CAPROVER_URL }}
          CAPROVER_PASSWORD: ${{ secrets.CAPROVER_PASSWORD }}
          CAPROVER_APP_NAME: ${{ secrets.CAPROVER_BACKEND_STAGING_APP_NAME }}
        run: |
          caprover deploy \
            --caproverUrl "$CAPROVER_URL" \
            --caproverPassword "$CAPROVER_PASSWORD" \
            --appName "$CAPROVER_APP_NAME" \
            --tarFile backend-deploy.tar.gz
          
          echo "‚úÖ Backend deployed successfully to CapRover (Staging)!"
          echo "üîó Backend URL: https://staging-api.indexo.ir"
          echo "üìù Note: Migrations and static files are collected automatically via Dockerfile CMD"

