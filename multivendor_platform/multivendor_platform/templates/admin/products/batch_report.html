{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    .report-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0;
    }
    
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 8px 8px 0 0;
    }
    
    .report-header h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
    }
    
    .report-header p {
        margin: 0;
        opacity: 0.9;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        padding: 30px;
        background: white;
    }
    
    .summary-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #dee2e6;
    }
    
    .summary-card.total { border-left-color: #007bff; }
    .summary-card.completed { border-left-color: #28a745; }
    .summary-card.failed { border-left-color: #dc3545; }
    .summary-card.rate { border-left-color: #ffc107; }
    .summary-card.duration { border-left-color: #6c757d; }
    
    .summary-number {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .summary-card.total .summary-number { color: #007bff; }
    .summary-card.completed .summary-number { color: #28a745; }
    .summary-card.failed .summary-number { color: #dc3545; }
    .summary-card.rate .summary-number { color: #ffc107; }
    .summary-card.duration .summary-number { color: #6c757d; font-size: 24px; }
    
    .summary-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 500;
    }
    
    .report-section {
        background: white;
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .report-section h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
        color: #333;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
    }
    
    .jobs-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .jobs-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .jobs-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        font-size: 13px;
    }
    
    .jobs-table tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-badge.success {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-badge.error {
        background: #f8d7da;
        color: #721c24;
    }
    
    .product-link {
        color: #28a745;
        text-decoration: none;
        font-weight: 500;
    }
    
    .product-link:hover {
        text-decoration: underline;
    }
    
    .url-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .action-buttons {
        background: white;
        padding: 20px 30px;
        border-radius: 0 0 8px 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
    }
    
    .btn-primary:hover {
        background: #5568d3;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h1>üìä {{ report.batch_name }}</h1>
        <p>Complete scraping report with detailed statistics and job results</p>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card total">
            <div class="summary-number">{{ report.summary.total_urls }}</div>
            <div class="summary-label">Total URLs</div>
        </div>
        <div class="summary-card completed">
            <div class="summary-number">{{ report.summary.completed }}</div>
            <div class="summary-label">Completed</div>
        </div>
        <div class="summary-card failed">
            <div class="summary-number">{{ report.summary.failed }}</div>
            <div class="summary-label">Failed</div>
        </div>
        <div class="summary-card rate">
            <div class="summary-number">{{ report.summary.success_rate }}%</div>
            <div class="summary-label">Success Rate</div>
        </div>
        {% if report.summary.duration_seconds %}
        <div class="summary-card duration">
            <div class="summary-number">
                {% widthratio report.summary.duration_seconds 60 1 %}m {{ report.summary.duration_seconds|floatformat:0|add:"-60"|divisibleby:60|yesno:"0,X" }}s
            </div>
            <div class="summary-label">Duration</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Successful Jobs -->
    {% if report.successful_jobs %}
    <div class="report-section">
        <h2>‚úÖ Successful Jobs ({{ report.successful_jobs|length }})</h2>
        <table class="jobs-table">
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>URL</th>
                    <th>Product</th>
                    <th>Processed At</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for job in report.successful_jobs %}
                <tr>
                    <td><strong>#{{ job.id }}</strong></td>
                    <td class="url-cell" title="{{ job.url }}">{{ job.url }}</td>
                    <td>
                        {% if job.product_id %}
                        <a href="/admin/products/product/{{ job.product_id }}/change/" class="product-link">
                            {{ job.product_name|truncatewords:5 }}
                        </a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>{{ job.processed_at|slice:":19" }}</td>
                    <td><span class="status-badge success">‚úì Success</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Jobs with Warnings -->
    {% if report.warning_jobs %}
    <div class="report-section">
        <h2>‚ö†Ô∏è Completed with Warnings ({{ report.warning_jobs|length }})</h2>
        <table class="jobs-table">
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>URL</th>
                    <th>Product</th>
                    <th>Warnings</th>
                    <th>Processed At</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for job in report.warning_jobs %}
                <tr>
                    <td><strong>#{{ job.id }}</strong></td>
                    <td class="url-cell" title="{{ job.url }}">{{ job.url }}</td>
                    <td>
                        {% if job.product_id %}
                        <a href="/admin/products/product/{{ job.product_id }}/change/" class="product-link">
                            {{ job.product_name|truncatewords:5 }}
                        </a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td><span style="color: #ffc107;">{{ job.warnings }} warning(s)</span></td>
                    <td>{{ job.processed_at|slice:":19" }}</td>
                    <td><span class="status-badge warning">‚ö†Ô∏è Warning</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Failed Jobs -->
    {% if report.failed_jobs %}
    <div class="report-section">
        <h2>‚ùå Failed Jobs ({{ report.failed_jobs|length }})</h2>
        <table class="jobs-table">
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>URL</th>
                    <th>Error</th>
                    <th>Processed At</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for job in report.failed_jobs %}
                <tr>
                    <td><strong>#{{ job.id }}</strong></td>
                    <td class="url-cell" title="{{ job.url }}">{{ job.url }}</td>
                    <td style="color: #dc3545; max-width: 300px;">{{ job.error|truncatewords:10 }}</td>
                    <td>{{ job.processed_at|slice:":19"|default:"-" }}</td>
                    <td><span class="status-badge error">‚úó Failed</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="report-section">
        <div class="empty-state">
            <div class="empty-state-icon">üéâ</div>
            <p style="font-size: 18px; font-weight: 500; margin: 0;">No Failed Jobs!</p>
            <p style="font-size: 14px; margin: 10px 0 0 0;">All URLs were scraped successfully.</p>
        </div>
    </div>
    {% endif %}
    
    <div class="action-buttons">
        <div>
            <a href="/admin/products/scrapejobatch/" class="btn btn-secondary">
                ‚Üê Back to Batches
            </a>
        </div>
        <div style="display: flex; gap: 10px;">
            {% if report.failed_jobs %}
            <a href="/admin/products/scrapejobatch/{{ batch.id }}/retry-failed/" class="btn btn-danger">
                üîÑ Retry {{ report.failed_jobs|length }} Failed Job(s)
            </a>
            {% endif %}
            <a href="{% url 'admin:products_productscrapejob_changelist' %}?batch__id={{ batch.id }}" class="btn btn-primary">
                üìã View All Jobs in This Batch
            </a>
            <button onclick="window.print()" class="btn btn-success">
                üñ®Ô∏è Print Report
            </button>
        </div>
    </div>
</div>

<script>
// Auto-refresh if batch is still processing
{% if not batch.is_complete %}
setTimeout(function() {
    location.reload();
}, 5000);  // Refresh every 5 seconds while processing
{% endif %}
</script>
{% endblock %}

